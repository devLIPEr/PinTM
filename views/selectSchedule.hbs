<!DOCTYPE html>
<html lang="en">
{{> headController }}
<body onload="bodyLoad()">
    {{> headerController }}
    <main class="mainSelectHorario">
        <div class="h2SelectHorario">
            <h2>Melhores Horários</h2>
        </div>
        <table>
            <tr>
                <th></th>
                <th>Seg</th>
                <th>Ter</th>
                <th>Qua</th>
                <th>Qui</th>
                <th>Sex</th>
                <th>Sab</th>
            </tr>
            <tr class="blankRow">
                <td colspan="3"></td>
            </tr>
            {{#horarios}} {{!-- Tabela de Horários --}}
                {{#each this}} {{!-- Período --}}
                    <tr>
                        <td>{{horario}}</td> {{!-- Horário do Período (07:30) --}}
                        {{#qualities}} {{!-- Array de qualidades (gerado pelo algoritmo) --}}
                            <td selected="0" quality="{{quality}}"></td> {{!-- Qualidade do horário --}}
                        {{/qualities}}
                    </tr>
                {{/each}}
            {{/horarios}}
        </table>
        <div class="formSelectHorario">
            <input id="week" type="week">
            <select name="salaInput" id="salaInput">
                <option value="" disabled selected>Sala:</option>
                {{#salas}}
                    <option value="{{sala}}">{{sala}}</option>
                {{/salas}}
            </select>
            <div class="compartilharBtn">
                <img src="../images/compartilharPDF.png" alt="Compartilhar via PDF">
            </div>
            <div class="compartilharBtn">
                <img src="../images/compartilharEmail.png" alt="Compartilhar por mensagem" onclick="copiarAreaTransferencia()">
                {{!-- FALTA ADICIONAR OS PARÂMETROS, EU NÃO FAÇO IDEIA DE COMO EXTRAIR OS DADOS QUE A GENTE PRECISA --}}
            </div>
        </div>
    </main>
    {{> footer }}
    <script>
        var selectedClasses = [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0]
        ];
        var times = ['07:30', '08:20', '09:10', '10:10', '11:00', '13:20', '14:10', '15:00', '16:00', '16:50', '17:40', '18:50', '19:40', '20:30', '21:30', '22:20'];

        function setClicks(){
            var tds = document.querySelectorAll('td[selected="0"]');
            for(var i = 0; i < tds.length; i++){
                tds[i].setAttribute("id", 'td'+i)
                tds[i].setAttribute("onclick", `changeSelected("#td${i}")`)
            }
        }

        function changeSelected(id){
            var td = document.querySelector(id);

            var index = parseInt(id.substr(3))
            var row = Math.floor(index/6);
            var col = index-row*6;
            selectedClasses[row][col] ^= 1;

            td.setAttribute("selected", (td.getAttribute("selected") == "0") ? "1" : "0");
        }

        function setDate(){
            var date = new Date();
            date = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            var firstDayOfYear = new Date(Date.UTC(date.getFullYear(), 0, 4));
            var days = Math.floor((date - firstDayOfYear) / (1000 * 60 * 60 * 24));
            var weekNumber = Math.ceil((days + firstDayOfYear.getUTCDay() + 1) / 7);
            if(weekNumber < 10){
                weekNumber = '0' + weekNumber;
            }
            document.getElementById("week").setAttribute("value", `${date.getFullYear()}-W${weekNumber}`);
            document.getElementById("week").setAttribute("min", `${date.getFullYear()}-W${weekNumber}`);
            document.getElementById("week").setAttribute("max", `${date.getFullYear() + 1}-W${weekNumber}`);
        }

        function createRepositions(){
            var transposedSchedule = selectedClasses[0].map((_, colIndex) => selectedClasses.map(row => row[colIndex]));
            var schedules = [];
            var schedule = {subject: 'materia', course: 'curso', date: '06/06/9420', start: '00:00', end: '00:00', classroom: 'Lab1'};

            for(var i = 0; i < 6; i++){
                for(var j = 0; j < 16; j++){
                    if(transposedSchedule[i][j]){
                        if(schedule['start'] == '00:00'){
                            schedule['start'] = times[j];
                        }
                    }else{
                        if(schedule['start'] != '00:00'){
                            schedule['end'] = times[j];
                            schedules.push(schedule);
                            schedule = {subject: 'materia', course: 'curso', date: '06/06/9420', start: '00:00', end: '00:00', classroom: 'Lab1'};
                        }
                    }
                }
            }
        }

        function bodyLoad(){
            setClicks();
            setDate();
        }
        
        function copiarAreaTransferencia(materia, curso, data, horario, local){
            texto = "Aviso: Reposição de " + materia + " do curso de " + curso + ", dia " + data + " às " + horario + " no local " + local + ".";
            navigator.clipboard.writeText(texto);
            alert("Texto copiado para a área de transferência.");
        }
    </script>
</body>
</html>